<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>AudioScribe - Transcripción Pro</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
    <script type="importmap">
    {
      "imports": {
        "@google/genai": "https://esm.sh/@google/genai@^1.38.0"
      }
    }
    </script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #0b141a;
            color: #e9edef;
            -webkit-tap-highlight-color: transparent;
            overflow: hidden;
            height: 100vh;
        }

        .recording-pulse {
            animation: pulse 1.5s infinite;
        }

        @keyframes pulse {
            0% {
                transform: scale(1);
                box-shadow: 0 0 0 0 rgba(0, 168, 132, 0.7);
            }

            70% {
                transform: scale(1.05);
                box-shadow: 0 0 0 20px rgba(0, 168, 132, 0);
            }

            100% {
                transform: scale(1);
                box-shadow: 0 0 0 0 rgba(0, 168, 132, 0);
            }
        }

        .spinner {
            animation: rotate 1s linear infinite;
        }

        @keyframes rotate {
            from {
                transform: rotate(0deg);
            }

            to {
                transform: rotate(360deg);
            }
        }

        .view {
            display: none;
        }

        .view.active {
            display: flex;
        }

        textarea::-webkit-scrollbar {
            width: 4px;
        }

        textarea::-webkit-scrollbar-thumb {
            background: #2a3942;
            border-radius: 10px;
        }

        .fade-in {
            animation: fadeIn 0.4s ease-out;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
    </style>
    <link rel="stylesheet" href="/index.css">
</head>

<body class="flex flex-col">

    <header class="w-full flex justify-between items-center p-5 border-b border-gray-800/50 bg-[#0b141a] z-50">
        <h1 class="text-xl font-extrabold text-[#00a884] flex items-center gap-2">
            <div class="bg-[#00a884] p-1.5 rounded-lg">
                <svg viewBox="0 0 24 24" width="20" height="20" fill="#0b141a">
                    <path
                        d="M12 2C6.48 2 2 6.48 2 12C2 17.52 6.48 22 12 22C17.52 22 22 17.52 22 12C22 6.48 17.52 2 12 2ZM12 20C7.59 20 4 16.41 4 12C4 7.59 7.59 4 12 4C16.41 4 20 7.59 20 12C20 16.41 16.41 20 12 20ZM11 7H13V13H11V7ZM11 15H13V17H11V15Z" />
                </svg>
            </div>
            AudioScribe
        </h1>
    </header>

    <main class="flex-1 w-full max-w-md mx-auto flex flex-col p-6 overflow-hidden">

        <!-- Vista: Inicio -->
        <section id="view-idle" class="view active flex-col items-center justify-center h-full text-center fade-in">
            <h2 class="text-4xl font-black mb-4 tracking-tight leading-tight">Tu voz, <br><span
                    class="text-[#00a884]">hecha texto.</span></h2>
            <p class="text-[#8696a0] mb-12 text-lg font-medium">Graba notas de voz y envíalas transcritas al instante.
            </p>
            <button id="btn-start"
                class="relative w-44 h-44 rounded-full bg-[#00a884] flex items-center justify-center transition-all active:scale-90 shadow-2xl hover:bg-[#06cf9c]">
                <svg xmlns="http://www.w3.org/2000/svg" width="60" height="60" viewBox="0 0 24 24" fill="none"
                    stroke="#0b141a" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M12 2a3 3 0 0 0-3 3v7a3 3 0 0 0 6 0V5a3 3 0 0 0-3-3Z" />
                    <path d="M19 10v2a7 7 0 0 1-14 0v-2" />
                    <line x1="12" x2="12" y1="19" y2="22" />
                </svg>
                <div class="absolute inset-0 bg-[#00a884]/20 blur-[60px] rounded-full -z-10"></div>
            </button>
            <p class="mt-10 text-gray-600 font-bold uppercase tracking-widest text-[10px]">Toca para grabar</p>
        </section>

        <!-- Vista: Grabando -->
        <section id="view-recording" class="view flex-col items-center justify-center h-full text-center fade-in">
            <div class="mb-12">
                <div
                    class="w-60 h-60 rounded-full border-[6px] border-[#00a884]/10 flex items-center justify-center mx-auto relative">
                    <div class="absolute inset-3 border-[4px] border-[#00a884] rounded-full recording-pulse"></div>
                    <span id="timer" class="text-6xl font-mono text-[#00a884] font-black tabular-nums">00:00</span>
                </div>
            </div>
            <button id="btn-stop"
                class="w-20 h-20 rounded-full bg-[#f15c5c] flex items-center justify-center mx-auto transition-all active:scale-95 shadow-xl">
                <div class="w-7 h-7 bg-white rounded-sm"></div>
            </button>
            <p class="mt-8 text-[#f15c5c] font-black uppercase tracking-[0.4em] animate-pulse text-xs">Grabando audio...
            </p>
        </section>

        <!-- Vista: Procesando -->
        <section id="view-processing" class="view flex-col items-center justify-center h-full text-center fade-in">
            <div class="mb-12">
                <svg class="spinner mx-auto text-[#00a884]" width="70" height="70" viewBox="0 0 24 24" fill="none"
                    stroke="currentColor" stroke-width="3">
                    <path d="M21 12a9 9 0 1 1-6.219-8.56" />
                </svg>
            </div>
            <h2 class="text-3xl font-black mb-3 text-[#00a884]">Analizando</h2>
            <p class="text-[#8696a0] font-medium">Gemini está transcribiendo tu audio...</p>
        </section>

        <!-- Vista: Resultado -->
        <section id="view-result" class="view flex-col h-full fade-in">
            <div
                class="flex-1 bg-[#202c33] rounded-3xl p-6 shadow-2xl border border-white/5 mb-6 overflow-hidden flex flex-col">
                <textarea id="result-text"
                    class="w-full flex-1 bg-transparent resize-none focus:outline-none text-xl font-medium leading-relaxed text-[#d1d7db] placeholder-gray-700"
                    spellcheck="false"></textarea>
            </div>

            <div class="grid grid-cols-1 gap-3">
                <button id="btn-share-main"
                    class="w-full flex items-center justify-center gap-3 bg-[#00a884] text-[#0b141a] font-black text-lg py-5 rounded-2xl shadow-lg active:scale-95 transition-all">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"
                        stroke-linecap="round" stroke-linejoin="round">
                        <path d="M22 2L11 13" />
                        <path d="M22 2l-7 20-4-9-9-4 20-7z" />
                    </svg>
                    ENVIAR A WHATSAPP
                </button>

                <div class="grid grid-cols-2 gap-3">
                    <button id="btn-copy"
                        class="flex items-center justify-center gap-2 bg-[#2a3942] hover:bg-[#374954] text-[#00a884] py-4 rounded-xl font-bold transition-all active:scale-95">
                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                            stroke-width="2.5">
                            <rect x="9" y="9" width="13" height="13" rx="2" ry="2" />
                            <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1" />
                        </svg>
                        Copiar
                    </button>
                    <button id="btn-download"
                        class="flex items-center justify-center gap-2 bg-[#2a3942] hover:bg-[#374954] text-white py-4 rounded-xl font-bold transition-all active:scale-95">
                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                            stroke-width="2.5">
                            <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4" />
                            <polyline points="7 10 12 15 17 10" />
                            <line x1="12" y1="15" x2="12" y2="3" />
                        </svg>
                        Audio .webm
                    </button>
                </div>

                <button id="btn-new"
                    class="w-full py-2 text-[#8696a0] font-black uppercase tracking-widest text-[10px] hover:text-[#00a884] transition-colors">
                    — Nueva nota —
                </button>
            </div>
        </section>
    </main>

    <!-- Toast Notification -->
    <div id="toast"
        class="fixed bottom-10 left-10 right-10 bg-[#00a884] text-[#0b141a] px-6 py-4 rounded-2xl flex items-center gap-3 shadow-2xl z-[100] transition-all transform translate-y-40 opacity-0">
        <svg id="toast-icon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor"
            stroke-width="3">
            <polyline points="20 6 9 17 4 12" />
        </svg>
        <span id="toast-msg" class="text-sm font-black uppercase">Copiado</span>
    </div>

    <script type="module">
        // Configuración eliminada del cliente, se maneja en el backend (Netlify Function)

        // Estado Global
        let mediaRecorder;
        let audioChunks = [];
        let timerInterval;
        let seconds = 0;
        let lastAudioBlob = null;
        let currentMimeType = 'audio/webm';
        let shareStep = 1; // 1: Audio, 2: Text

        // Elementos DOM
        const views = {
            idle: document.getElementById('view-idle'),
            recording: document.getElementById('view-recording'),
            processing: document.getElementById('view-processing'),
            result: document.getElementById('view-result')
        };
        const els = {
            timer: document.getElementById('timer'),
            textarea: document.getElementById('result-text'),
            btnStart: document.getElementById('btn-start'),
            btnStop: document.getElementById('btn-stop'),
            btnShareMain: document.getElementById('btn-share-main'),
            btnCopy: document.getElementById('btn-copy'),
            btnDownload: document.getElementById('btn-download'),
            btnNew: document.getElementById('btn-new'),
            toast: document.getElementById('toast'),
            toastMsg: document.getElementById('toast-msg')
        };

        function switchView(viewName) {
            Object.values(views).forEach(v => v.classList.remove('active'));
            views[viewName].classList.add('active');
        }

        function showToast(msg, isSuccess = true) {
            els.toastMsg.innerText = msg;
            els.toast.style.backgroundColor = isSuccess ? '#00a884' : '#f15c5c';
            els.toast.classList.remove('translate-y-40', 'opacity-0');
            setTimeout(() => {
                els.toast.classList.add('translate-y-40', 'opacity-0');
            }, 3000);
        }

        async function startRecording() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });

                // Forzar WebM para asegurar compatibilidad con WhatsApp y reducir tamaño
                const preferredTypes = ['audio/webm;codecs=opus', 'audio/webm'];
                const mime = preferredTypes.find(t => MediaRecorder.isTypeSupported(t)) || 'audio/webm';
                currentMimeType = mime;

                mediaRecorder = new MediaRecorder(stream, { mimeType: currentMimeType });
                audioChunks = [];

                mediaRecorder.ondataavailable = e => {
                    if (e.data.size > 0) audioChunks.push(e.data);
                };

                mediaRecorder.onstop = async () => {
                    lastAudioBlob = new Blob(audioChunks, { type: currentMimeType });
                    switchView('processing');
                    await processTranscription();
                    stream.getTracks().forEach(t => t.stop());
                };

                mediaRecorder.start();
                switchView('recording');

                seconds = 0;
                els.timer.innerText = "00:00";
                clearInterval(timerInterval);
                timerInterval = setInterval(() => {
                    seconds++;
                    const m = Math.floor(seconds / 60).toString().padStart(2, '0');
                    const s = (seconds % 60).toString().padStart(2, '0');
                    els.timer.innerText = `${m}:${s}`;
                }, 1000);

            } catch (err) {
                console.error(err);
                alert("Error: Asegúrate de habilitar el micrófono.");
            }
        }

        async function processTranscription() {
            try {
                // Convertir Blob a Base64
                const reader = new FileReader();
                const base64Promise = new Promise(resolve => {
                    reader.onloadend = () => resolve(reader.result.split(',')[1]);
                    reader.readAsDataURL(lastAudioBlob);
                });
                const base64Data = await base64Promise;

                // Llamada a la Netlify Function
                const response = await fetch('/.netlify/functions/transcribe', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        audioData: base64Data,
                        mimeType: currentMimeType
                    })
                });

                if (!response.ok) {
                    throw new Error(`Server error: ${response.status}`);
                }

                const data = await response.json();
                const text = data.text || "(Transcripción vacía)";
                els.textarea.value = text;

                shareStep = 1;
                updateMainButton();
                switchView('result');

            } catch (err) {
                console.error(err);
                showToast("Error en la transcripción. Verifica tu conexión.", false);
                switchView('idle');
            }
        }

        function updateMainButton() {
            if (shareStep === 1) {
                els.btnShareMain.innerHTML = `
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><path d="M12 1a3 3 0 0 0-3 3v7a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"/><path d="M19 10v2a7 7 0 0 1-14 0v-2"/><line x1="12" y1="19" x2="12" y2="23"/><line x1="8" y1="23" x2="16" y2="23"/></svg>
                    1. ENVIAR AUDIO`;
                els.btnShareMain.className = "w-full flex items-center justify-center gap-3 bg-[#00a884] text-[#0b141a] font-black text-lg py-5 rounded-2xl shadow-lg active:scale-95 transition-all";
            } else {
                els.btnShareMain.innerHTML = `
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/><polyline points="10 9 9 9 8 9"/></svg>
                    2. ENVIAR TEXTO`;
                els.btnShareMain.className = "w-full flex items-center justify-center gap-3 bg-[#3b82f6] text-white font-black text-lg py-5 rounded-2xl shadow-lg active:scale-95 transition-all animate-pulse";
            }
        }

        async function handleShare() {
            if (shareStep === 1) {
                const file = new File([lastAudioBlob], `Nota_${Date.now()}.webm`, { type: 'audio/webm' });

                if (navigator.share && navigator.canShare && navigator.canShare({ files: [file] })) {
                    try {
                        await navigator.share({ files: [file], title: 'Nota de Voz' });
                        shareStep = 2;
                        updateMainButton();
                        showToast("¡Audio enviado! Paso 2: El texto.");
                    } catch (e) { console.log("Compartido cancelado"); }
                } else {
                    downloadAudio();
                    shareStep = 2;
                    updateMainButton();
                    showToast("Audio guardado (.webm)");
                }
            } else {
                const text = els.textarea.value;
                if (navigator.share) {
                    try {
                        await navigator.share({ text: text });
                        showToast("¡Texto compartido!");
                    } catch (e) { console.log("Compartido cancelado"); }
                } else {
                    copyToClipboard();
                    window.open(`https://wa.me/?text=${encodeURIComponent(text)}`, '_blank');
                }
            }
        }

        function downloadAudio() {
            if (!lastAudioBlob) return;
            const url = URL.createObjectURL(lastAudioBlob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `AudioScribe_${Date.now()}.webm`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            showToast("Guardado en descargas");
        }

        async function copyToClipboard() {
            const text = els.textarea.value;
            try {
                if (navigator.clipboard && navigator.clipboard.writeText) {
                    await navigator.clipboard.writeText(text);
                } else {
                    els.textarea.select();
                    document.execCommand('copy');
                }
                showToast("Copiado al portapapeles");
            } catch (err) {
                alert("Error al copiar. Selecciona el texto manualmente.");
            }
        }

        // Event Listeners
        els.btnStart.onclick = startRecording;
        els.btnStop.onclick = () => {
            if (mediaRecorder) {
                mediaRecorder.stop();
                clearInterval(timerInterval);
            }
        };
        els.btnShareMain.onclick = handleShare;
        els.btnCopy.onclick = copyToClipboard;
        els.btnDownload.onclick = downloadAudio;
        els.btnNew.onclick = () => switchView('idle');
    </script>
    <script type="module" src="/index.tsx"></script>
</body>

</html>